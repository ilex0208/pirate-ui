"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}Object.defineProperty(exports,"__esModule",{value:!0});var _react=require("react"),_react2=_interopRequireDefault(_react),_reactDom=require("react-dom"),_classnames=require("classnames"),_classnames2=_interopRequireDefault(_classnames),_dt2react=require("dt2react"),_prefix=require("./_prefix"),_prefix2=_interopRequireDefault(_prefix),_RenderData=require("./RenderData"),_RenderData2=_interopRequireDefault(_RenderData),_RenderRow=require("./RenderRow"),_RenderRow2=_interopRequireDefault(_RenderRow),execRowKey="_"+(1e18*Math.random()).toString(36).slice(0,5).toUpperCase(),isIE8=function(){return!!navigator.userAgent.match(/MSIE 8.0/)},ReactChildren=_react2.default.Children,Table=_react2.default.createClass({displayName:"Table",propTypes:{width:_react.PropTypes.number,data:_react.PropTypes.array.isRequired,height:_react.PropTypes.number,rowHeight:_react.PropTypes.number,headerHeight:_react.PropTypes.number,scrollLeft:_react.PropTypes.number,scrollTop:_react.PropTypes.number,onRowClick:_react.PropTypes.func,isTree:_react.PropTypes.bool,expand:_react.PropTypes.bool,locale:_react.PropTypes.object,sortColumn:_react.PropTypes.string,sortType:_react.PropTypes.oneOf(["desc","asc"]),onSortColumn:_react.PropTypes.func,classPrefix:_react.PropTypes.string,children:_react.PropTypes.any,className:_react.PropTypes.any,style:_react.PropTypes.any,id:_react.PropTypes.any},getDefaultProps:function(){return{classPrefix:"ray-table",height:200,rowHeight:36,sortType:"asc",locale:{emptyMessage:"No data found"}}},getInitialState:function(){return{columnWidth:0,mouseAreaLeft:-1,dataKey:0,scrollLeft:0,scrollTop:0,resizeColumnFixed:!1}},componentDidMount:function(){this._onBodyScrollListener=(0,_dt2react.on)(this.refs.tableBody,"scroll",this.handleBodyScroll)},componentDidUpdate:function(e){this.handleBodyScroll()},componentWillUnmount:function(){this._onBodyScrollListener&&this._onBodyScrollListener.off()},getFixedCellGroups:function(){return(0,_reactDom.findDOMNode)(this.refs.table).querySelectorAll("."+this.props.classPrefix+"-cell-group.fixed")},getCells:function(){var e=this,r=0,t=!1,a=[],o=[],l=this.props.children,s=this.props,n=s.sortColumn,i=s.sortType,d=s.onSortColumn;return ReactChildren.map(l,function(s,c){var u=s.props.children,p=s.props,h=p.width,f=p.fixed,_=p.align,m=p.sortable,y=p.resizable;if(2!==u.length)throw new Error("Component <HeaderCell> and <Cell> is required, column index: "+c+" ");f&&(t=!0),h=e.state[u[1].props.dataKey+"_"+c+"_width"]||h;var C={width:h,fixed:f,left:r,align:_,resizable:y,sortable:m,index:c,height:e.props.rowHeight,headerHeight:e.props.headerHeight,firstColumn:0===c,lastColumn:c===l.length-1,key:c},g={headerHeight:e.props.headerHeight||e.props.rowHeight,dataKey:u[1].props.dataKey,sortColumn:n,sortType:i,onSortColumn:d};y&&(g.onColumnResizeEnd=e._onColumnResizeEnd,g.onColumnResize=e._onColumnResize,g.onColumnResizeMove=e._onColumnResizeMove),a.push(e.cloneCell(u[0],Object.assign(C,g))),o.push(e.cloneCell(u[1],C)),r+=h}),{headerCells:a,bodyCells:o,isFixedColumn:t,allColumnsWidth:r}},_onTreeToggle:function(e,r){console.log("treeToggle:"+e),(0,_dt2react.toggleClass)((0,_reactDom.findDOMNode)(this.refs["children_"+e+"_"+r]),"open")},randerRowData:function(e,r,t){var a=this,o=this.props,l=o.onRowClick,s=o.classPrefix,n=this.props.isTree&&r.children&&Array.isArray(r.children)&&r.children.length>0,i={key:t.index,rowIndex:t.index,width:t.rowWidth,height:t.rowHeight,top:t.top,onClick:function(){l&&l(r)},rowData:r},d="rr_"+t.index,c=_react2.default.createElement(_RenderRow2.default,{key:d,renderRowProps:i,cells:e.map(function(e,o){return _react2.default.cloneElement(e,{key:o,layer:t.layer,hasChildren:n,rowIndex:t.index,onTreeToggle:a._onTreeToggle,rowKey:execRowKey,rowData:r},e.props.children)})});if(n){t.layer++;var u=(0,_classnames2.default)((0,_prefix2.default)(s)("row-children"),{open:this.props.expand}),p="children_"+execRowKey+"_"+t.index;return _react2.default.createElement(_RenderData2.default,{key:p,childrenClasses:u,layer:t.layer,_refs:p,index:t.index,row:c,rowData:r,bodyCells:e,randerRowData:this.randerRowData,_props:t})}return c},cloneCell:function(e,r){return _react2.default.cloneElement(e,r,e.props.children)},handleBodyScroll:function(){var e=this.refs,r=e.tableBody,t=e.tableHeader,a=(0,_reactDom.findDOMNode)(t),o=this.getFixedCellGroups(),l={addClass:_dt2react.addClass,removeClass:_dt2react.removeClass},s=(0,_dt2react.scrollLeft)(r),n=(0,_dt2react.scrollTop)(r);this.scrollLeft=s,Array.from(o).map(function(e){(0,_dt2react.addStyle)(e,{left:s+"px"});var r=s>1?"addClass":"removeClass";!isIE8&&l[r](e,"shadow")}),(0,_dt2react.addStyle)(a,{left:-s+"px"});var i=n>1?"addClass":"removeClass";!isIE8&&l[i](a,"shadow")},_onColumnResizeEnd:function(e,r,t,a){this.setState(_defineProperty({isColumnResizing:!1,mouseAreaLeft:-1},t+"_"+a+"_width",e))},_onColumnResize:function(e,r,t){this.setState({isColumnResizing:!0})},_onColumnResizeMove:function(e,r,t){this.setState({resizeColumnFixed:t,mouseAreaLeft:e+r})},render:function(){var e=this,r=this.props,t=r.className,a=r.width,o=void 0===a?0:a,l=r.height,s=r.style,n=r.classPrefix,i=r.isTree,d=r.id,c=r.headerHeight,u=r.rowHeight,p=r.data,h=this.getCells(),f=h.headerCells,_=h.bodyCells,m=h.allColumnsWidth,y=h.isFixedColumn,C=m>o?m:o;this.isFixedColumn=y;var g=(0,_classnames2.default)(n,i?(0,_prefix2.default)(n)("treetable"):"",t,{"column-resizing":this.state.isColumnResizing}),w=Object.assign({width:o||"auto",height:l},s),R={width:C,height:u,headerHeight:c,isHeaderRow:!0,top:0},x=this.scrollLeft||0,T=this.state,b=T.mouseAreaLeft,P=T.resizeColumnFixed,v={height:l,left:P?b:b-x},D={top:i?0:c||u,height:l-(c||u)},E=0,z=0,S=p.length>0?p.map(function(r,t){var a=e.randerRowData(_,r,{index:t,top:E,rowWidth:C,rowHeight:u,layer:z});return!i&&(E+=u),a}):_react2.default.createElement("div",{className:(0,_prefix2.default)(n)("body-info")},this.props.locale.emptyMessage);return _react2.default.createElement("div",{className:g,style:w,ref:"table",id:d},_react2.default.createElement("div",{className:(0,_prefix2.default)(n)("header-row-wrapper")},_react2.default.createElement(_RenderRow2.default,{renderRowProps:R,cells:f})),_react2.default.createElement("div",{ref:"tableBody",className:(0,_prefix2.default)(n)("body-row-wrapper"),style:D},S),!isIE8&&_react2.default.createElement("div",{ref:"mouseArea",className:(0,_prefix2.default)(n)("mouse-area"),style:v}))}});exports.default=Table;