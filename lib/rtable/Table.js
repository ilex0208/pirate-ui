"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_TableRow=require("./TableRow"),_TableRow2=_interopRequireDefault(_TableRow),_TableHeader=require("./TableHeader"),_TableHeader2=_interopRequireDefault(_TableHeader),_utils=require("./utils"),_simpleCompare=require("./../common/simpleCompare"),_addEventListener=require("./../common/addEventListener"),_addEventListener2=_interopRequireDefault(_addEventListener),_ColumnManager=require("./ColumnManager"),_ColumnManager2=_interopRequireDefault(_ColumnManager),_createStore=require("./createStore"),_createStore2=_interopRequireDefault(_createStore),RayTable=function(e){function t(e){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));_initialiseProps.call(r);var o=[],n=[].concat(_toConsumableArray(e.data));if(r.columnManager=new _ColumnManager2.default(e.columns,e.children),r.store=(0,_createStore2.default)({currentHoverKey:null}),e.defaultExpandAllRows)for(var a=0;a<n.length;a++){var l=n[a];o.push(r.getRowKey(l,a)),n=n.concat(l[e.childrenColumnName]||[])}else o=e.expandedRowKeys||e.defaultExpandedRowKeys;return r.state={expandedRowKeys:o,data:e.data,currentHoverKey:null,scrollPosition:"left",fixedColumnsHeadRowsHeight:[],fixedColumnsBodyRowsHeight:[]},r}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){this.resetScrollY(),this.columnManager.isAnyColumnsFixed()&&(this.syncFixedTableRowHeight(),this.resizeEvent=(0,_addEventListener2.default)(window,"resize",(0,_utils.debounce)(this.syncFixedTableRowHeight,150)))}},{key:"componentWillReceiveProps",value:function(e){"data"in e&&(this.setState({data:e.data}),e.data&&0!==e.data.length||this.resetScrollY()),"expandedRowKeys"in e&&this.setState({expandedRowKeys:e.expandedRowKeys}),e.columns&&e.columns!==this.props.columns?this.columnManager.reset(e.columns):e.children!==this.props.children&&this.columnManager.reset(null,e.children)}},{key:"componentDidUpdate",value:function(){this.syncFixedTableRowHeight()}},{key:"componentWillUnmount",value:function(){this.resizeEvent&&this.resizeEvent.remove()}},{key:"render",value:function(){var e=this.props,t=e.prefixCls,r=e.prefixCls;e.className&&(r+=" "+e.className),(e.useFixedHeader||e.scroll&&e.scroll.y)&&(r+=" "+t+"-fixed-header"),r+=" "+t+"-scroll-position-"+this.state.scrollPosition;var o=this.columnManager.isAnyColumnsFixed()||e.scroll.x||e.scroll.y;return _react2.default.createElement("div",{className:r,style:e.style},this.getTitle(),_react2.default.createElement("div",{className:t+"-content"},this.columnManager.isAnyColumnsLeftFixed()&&_react2.default.createElement("div",{className:t+"-fixed-left"},this.getLeftFixedTable()),_react2.default.createElement("div",{className:o?t+"-scroll":""},this.getTable({columns:this.columnManager.groupedColumns()}),this.getEmptyText(),this.getFooter()),this.columnManager.isAnyColumnsRightFixed()&&_react2.default.createElement("div",{className:t+"-fixed-right"},this.getRightFixedTable())))}}]),t}(_react.Component);RayTable.propTypes={data:_react.PropTypes.array,expandIconAsCell:_react.PropTypes.bool,defaultExpandAllRows:_react.PropTypes.bool,expandedRowKeys:_react.PropTypes.array,defaultExpandedRowKeys:_react.PropTypes.array,useFixedHeader:_react.PropTypes.bool,columns:_react.PropTypes.array,prefixCls:_react.PropTypes.string,bodyStyle:_react.PropTypes.object,style:_react.PropTypes.object,rowKey:_react.PropTypes.oneOfType([_react.PropTypes.string,_react.PropTypes.func]),rowClassName:_react.PropTypes.func,expandedRowClassName:_react.PropTypes.func,childrenColumnName:_react.PropTypes.string,onExpand:_react.PropTypes.func,onExpandedRowsChange:_react.PropTypes.func,indentSize:_react.PropTypes.number,onRowClick:_react.PropTypes.func,onRowDoubleClick:_react.PropTypes.func,expandIconColumnIndex:_react.PropTypes.number,showHeader:_react.PropTypes.bool,title:_react.PropTypes.func,footer:_react.PropTypes.func,emptyText:_react.PropTypes.func,scroll:_react.PropTypes.object,rowRef:_react.PropTypes.func,getBodyWrapper:_react.PropTypes.func,children:_react.PropTypes.node},RayTable.defaultProps={data:[],useFixedHeader:!1,expandIconAsCell:!1,defaultExpandAllRows:!1,defaultExpandedRowKeys:[],rowKey:"key",rowClassName:function(){return""},expandedRowClassName:function(){return""},onExpand:function(){},onExpandedRowsChange:function(){},onRowClick:function(){},onRowDoubleClick:function(){},prefixCls:"ray-table",bodyStyle:{},style:{},childrenColumnName:"children",indentSize:15,expandIconColumnIndex:0,showHeader:!0,scroll:{},rowRef:function(){return null},getBodyWrapper:function(e){return e},emptyText:function(){return"No Data"}};var _initialiseProps=function(){var e=this;this.onExpandedRowsChange=function(t){e.props.expandedRowKeys||e.setState({expandedRowKeys:t}),e.props.onExpandedRowsChange(t)},this.onExpanded=function(t,r,o,n){o&&(o.preventDefault(),o.stopPropagation());var a=e.findExpandedRow(r);if("undefined"==typeof a||t){if(!a&&t){var l=e.getExpandedRows().concat();l.push(e.getRowKey(r,n)),e.onExpandedRowsChange(l)}}else e.onRowDestroy(r,n);e.props.onExpand(t,r)},this.onRowDestroy=function(t,r){var o=e.getExpandedRows().concat(),n=e.getRowKey(t,r),a=-1;o.forEach(function(e,t){e===n&&(a=t)}),a!==-1&&o.splice(a,1),e.onExpandedRowsChange(o)},this.getRowKey=function(t,r){var o=e.props.rowKey,n="function"==typeof o?o(t,r):t[o];return(0,_utils.warningOnce)(void 0!==n,"Each record in table should have a unique `key` prop,or set `rowKey` to an unique primary key."),void 0===n?r:n},this.getExpandedRows=function(){return e.props.expandedRowKeys||e.state.expandedRowKeys},this.getHeader=function(t,r){var o=e.props,n=o.showHeader,a=o.expandIconAsCell,l=o.prefixCls,s=e.getHeaderRows(t);a&&"right"!==r&&s[0].unshift({key:"ray-table-expandIconAsCell",className:l+"-expand-icon-th",title:"",rowSpan:s.length});var i=r?e.getHeaderRowStyle(t,s):null;return n?_react2.default.createElement(_TableHeader2.default,{prefixCls:l,rows:s,rowStyle:i}):null},this.getHeaderRows=function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments[2];return o=o||[],o[r]=o[r]||[],t.forEach(function(t){if(t.rowSpan&&o.length<t.rowSpan)for(;o.length<t.rowSpan;)o.push([]);var n={key:t.key,className:t.className||"",children:t.title};t.children&&e.getHeaderRows(t.children,r+1,o),"colSpan"in t&&(n.colSpan=t.colSpan),"rowSpan"in t&&(n.rowSpan=t.rowSpan),0!==n.colSpan&&o[r].push(n)}),o.filter(function(e){return e.length>0})},this.getExpandedRow=function(t,r,o,n,a){var l=e.props,s=l.prefixCls,i=l.expandIconAsCell,c=void 0;c="left"===a?e.columnManager.leftLeafColumns().length:"right"===a?e.columnManager.rightLeafColumns().length:e.columnManager.leafColumns().length;var d=[{key:"extra-row",render:function(){return{props:{colSpan:c},children:"right"!==a?r:"&nbsp;"}}}];return i&&"right"!==a&&d.unshift({key:"expand-icon-placeholder",render:function(){return null}}),_react2.default.createElement(_TableRow2.default,{columns:d,visible:o,className:n,key:t+"-extra-row",prefixCls:s+"-expanded-row",indent:1,expandable:!1,store:e.store})},this.getRowsByData=function(t,r,o,n,a){for(var l=e.props,s=l.childrenColumnName,i=l.expandedRowRender,c=l.expandRowByClick,d=e.state.fixedColumnsBodyRowsHeight,u=[],p=l.rowClassName,f=l.rowRef,h=l.expandedRowClassName,y=l.data.some(function(e){return e[s]}),g=l.onRowClick,m=l.onRowDoubleClick,x="right"!==a&&l.expandIconAsCell,w="right"!==a?l.expandIconColumnIndex:-1,_=0;_<t.length;_++){var R=t[_],C=e.getRowKey(R,_),v=R[s],b=e.isRowExpanded(R,_),T=void 0;i&&b&&(T=i(R,_,o));var E=p(R,_,o),S={};e.columnManager.isAnyColumnsFixed()&&(S.onHover=e.handleRowHover);var P=a&&d[_]?d[_]:null,H=void 0;H="left"===a?e.columnManager.leftLeafColumns():"right"===a?e.columnManager.rightLeafColumns():e.columnManager.leafColumns(),u.push(_react2.default.createElement(_TableRow2.default,_extends({indent:o,indentSize:l.indentSize,needIndentSpaced:y,className:E,record:R,expandIconAsCell:x,onDestroy:e.onRowDestroy,index:_,visible:r,expandRowByClick:c,onExpand:e.onExpanded,expandable:v||i,expanded:b,prefixCls:l.prefixCls+"-row",childrenColumnName:s,columns:H,expandIconColumnIndex:w,onRowClick:g,onRowDoubleClick:m,height:P},S,{key:C,hoverKey:C,ref:f(R,_,o),store:e.store})));var N=r&&b;T&&b&&u.push(e.getExpandedRow(C,T,N,h(R,_,o),a)),v&&(u=u.concat(e.getRowsByData(v,N,o+1,n,a)))}return u},this.getRows=function(t,r){return e.getRowsByData(e.state.data,!0,0,t,r)},this.getColGroup=function(t,r){var o=[];e.props.expandIconAsCell&&"right"!==r&&o.push(_react2.default.createElement("col",{className:e.props.prefixCls+"-expand-icon-col",key:"ray-table-expand-icon-col"}));var n=void 0;return n="left"===r?e.columnManager.leftLeafColumns():"right"===r?e.columnManager.rightLeafColumns():e.columnManager.leafColumns(),o=o.concat(n.map(function(e){return _react2.default.createElement("col",{key:e.key,style:{width:e.width,minWidth:e.width}})})),_react2.default.createElement("colgroup",null,o)},this.getLeftFixedTable=function(){return e.getTable({columns:e.columnManager.leftColumns(),fixed:"left"})},this.getRightFixedTable=function(){return e.getTable({columns:e.columnManager.rightColumns(),fixed:"right"})},this.getTable=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.columns,o=t.fixed,n=e.props,a=n.prefixCls,l=n.scroll,s=void 0===l?{}:l,i=n.getBodyWrapper,c=e.props.useFixedHeader,d=_extends({},e.props.bodyStyle),u={},p="";if((s.x||o)&&(p=a+"-fixed",d.overflowX=d.overflowX||"auto"),s.y){o?d.height=d.height||s.y:d.maxHeight=d.maxHeight||s.y,d.overflowY=d.overflowY||"scroll",c=!0;var f=(0,_utils.measureScrollbar)();f>0&&((o?d:u).marginBottom="-"+f+"px",(o?d:u).paddingBottom="0px")}var h=function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],l={};!o&&s.x&&(s.x===!0?l.tableLayout="fixed":l.width=s.x);var c=n?i(_react2.default.createElement("tbody",{className:a+"-tbody"},e.getRows(r,o))):null;return _react2.default.createElement("table",{className:p,style:l},e.getColGroup(r,o),t?e.getHeader(r,o):null,c)},y=void 0;c&&(y=_react2.default.createElement("div",{className:a+"-header",ref:o?null:"headTable",style:u,onMouseOver:e.detectScrollTarget,onTouchStart:e.detectScrollTarget,onScroll:e.handleBodyScroll},h(!0,!1)));var g=_react2.default.createElement("div",{className:a+"-body",style:d,ref:"bodyTable",onMouseOver:e.detectScrollTarget,onTouchStart:e.detectScrollTarget,onScroll:e.handleBodyScroll},h(!c));if(o&&r.length){var m=void 0;"left"===r[0].fixed||r[0].fixed===!0?m="fixedColumnsBodyLeft":"right"===r[0].fixed&&(m="fixedColumnsBodyRight"),delete d.overflowX,delete d.overflowY,g=_react2.default.createElement("div",{className:a+"-body-outer",style:_extends({},d)},_react2.default.createElement("div",{className:a+"-body-inner",ref:m,onMouseOver:e.detectScrollTarget,onTouchStart:e.detectScrollTarget,onScroll:e.handleBodyScroll},h(!c)))}return _react2.default.createElement("span",null,y,g)},this.getTitle=function(){var t=e.props,r=t.title,o=t.prefixCls;return r?_react2.default.createElement("div",{className:o+"-title"},r(e.state.data)):null},this.getFooter=function(){var t=e.props,r=t.footer,o=t.prefixCls;return r?_react2.default.createElement("div",{className:o+"-footer"},r(e.state.data)):null},this.getEmptyText=function(){var t=e.props,r=t.emptyText,o=t.prefixCls,n=t.data;return n.length?null:_react2.default.createElement("div",{className:o+"-placeholder"},r())},this.getHeaderRowStyle=function(t,r){var o=e.state.fixedColumnsHeadRowsHeight,n=o[0];return n&&t?"auto"===n?{height:"auto"}:{height:n/r.length}:null},this.syncFixedTableRowHeight=function(){var t=e.props.prefixCls,r=e.refs.headTable?e.refs.headTable.querySelectorAll("thead"):e.refs.bodyTable.querySelectorAll("thead"),o=e.refs.bodyTable.querySelectorAll("."+t+"-row")||[],n=[].map.call(r,function(e){return e.getBoundingClientRect().height||"auto"}),a=[].map.call(o,function(e){return e.getBoundingClientRect().height||"auto"});(0,_simpleCompare.simpleEqual)(e.state.fixedColumnsHeadRowsHeight,n)&&(0,_simpleCompare.simpleEqual)(e.state.fixedColumnsBodyRowsHeight,a)||e.setState({fixedColumnsHeadRowsHeight:n,fixedColumnsBodyRowsHeight:a})},this.resetScrollY=function(){e.refs.headTable&&(e.refs.headTable.scrollLeft=0),e.refs.bodyTable&&(e.refs.bodyTable.scrollLeft=0)},this.findExpandedRow=function(t,r){var o=e.getExpandedRows().filter(function(o){return o===e.getRowKey(t,r)});return o[0]},this.isRowExpanded=function(t,r){return"undefined"!=typeof e.findExpandedRow(t,r)},this.detectScrollTarget=function(t){e.scrollTarget!==t.currentTarget&&(e.scrollTarget=t.currentTarget)},this.handleBodyScroll=function(t){if(t.target===e.scrollTarget){var r=e.props.scroll,o=void 0===r?{}:r,n=e.refs,a=n.headTable,l=n.bodyTable,s=n.fixedColumnsBodyLeft,i=n.fixedColumnsBodyRight;o.x&&t.target.scrollLeft!==e.lastScrollLeft&&(t.target===l&&a?a.scrollLeft=t.target.scrollLeft:t.target===a&&l&&(l.scrollLeft=t.target.scrollLeft),0===t.target.scrollLeft?e.setState({scrollPosition:"left"}):t.target.scrollLeft+1>=t.target.children[0].getBoundingClientRect().width-t.target.getBoundingClientRect().width?e.setState({scrollPosition:"right"}):"middle"!==e.state.scrollPosition&&e.setState({scrollPosition:"middle"})),o.y&&(s&&t.target!==s&&(s.scrollTop=t.target.scrollTop),i&&t.target!==i&&(i.scrollTop=t.target.scrollTop),l&&t.target!==l&&(l.scrollTop=t.target.scrollTop)),e.lastScrollLeft=t.target.scrollLeft}},this.handleRowHover=function(t,r){e.store.setState({currentHoverKey:t?r:null})}};exports.default=RayTable;